# P07 â€” Cloud-safe import, dedupe, merge (transactional)

## Implementation notes
- Added CSV and vCard import parsing with mapping, preview, validation, and summary responses.
- Implemented dedupe suggestions with exact channel matches and trigram-style name similarity (city/org heuristics).
- Delivered transactional merge flow with survivor field selection, merged arrays, and relation reassignment.
- Created in-memory relation stores to validate merge invariants across interactions, commitments, needs/offers, edges, and memberships.

## UX coverage
- `/contacts` includes CSV/vCard import panel with mapping, preview, validation errors, and import summary.
- `/contacts` includes dedupe + merge panel with survivor selection, field pickers, and suggested duplicates.

## API surface
- `POST /api/contacts/import` `{ workspaceId, type: "csv" | "vcard", content, mapping?, action: "preview" | "import" }`
- `GET /api/contacts/dedupe?workspaceId=...`
- `POST /api/contacts/merge` `{ workspaceId, survivorId, sourceIds, selections }`

## Merge invariants
- All related records are reassigned to the survivor contact id.
- Contact channels, aliases, tags, organizations, communities, and notes are unioned.
- Merge executes transactionally; failures do not mutate contact or relation stores.

## Key files
- `lib/contacts-import.ts`
- `lib/contacts-dedupe.ts`
- `lib/contacts.ts`
- `lib/relations.ts`
- `app/api/contacts/import/route.ts`
- `app/api/contacts/dedupe/route.ts`
- `app/api/contacts/merge/route.ts`
- `components/contacts/contacts-import-panel.tsx`
- `components/contacts/contacts-merge-panel.tsx`

## Local verification
See `LOCAL_VERIFICATION.md` for the full checklist and P07 commands.
