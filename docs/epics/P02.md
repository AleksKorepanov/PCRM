# P02 — Auth + Workspaces + RBAC + Audit Logs

## Implementation notes
- Storage is an in-memory store (`lib/store.ts`) to keep the cloud-safe scope. This is a placeholder for a real database migration in later epics.
- Password hashing uses `scrypt` with per-user salts (`lib/auth.ts`).
- Sessions are stored server-side and referenced by an HTTP-only cookie (`pcrm_session`).
- RBAC helpers live in `lib/rbac.ts` and are enforced in route handlers.

## Key routes
- `POST /api/auth/register` — create user + session.
- `POST /api/auth/login` — login + session.
- `POST /api/auth/logout` — clear session.
- `GET /api/auth/me` — current user.
- `GET /api/workspaces` — list workspaces for user.
- `POST /api/workspaces` — create workspace + owner membership.
- `POST /api/workspaces/:workspaceId/switch` — switch active workspace.
- `POST /api/workspaces/:workspaceId/invites` — create invite.
- `POST /api/workspaces/:workspaceId/invites/:token/accept` — accept invite.
- `PATCH /api/workspaces/:workspaceId/members/:memberId/role` — update member role.
- `GET /api/workspaces/:workspaceId/audit` — view audit logs.

## RBAC enforcement (server-side)
Enforced in the following route handlers:
1. `POST /api/workspaces/:workspaceId/invites` (Owner/Admin only).
2. `PATCH /api/workspaces/:workspaceId/members/:memberId/role` (Owner/Admin only).
3. `GET /api/workspaces/:workspaceId/audit` (Owner/Admin/Assistant only).
4. `POST /api/workspaces/:workspaceId/switch` (must be a workspace member).
5. `POST /api/workspaces/:workspaceId/invites/:token/accept` (invite email must match user).

## Local verification
See `LOCAL_VERIFICATION.md` for the full checklist and P02 commands.
